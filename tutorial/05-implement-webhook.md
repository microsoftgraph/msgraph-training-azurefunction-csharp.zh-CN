---
ms.openlocfilehash: 181afe9acfe45ff619a50cf874669228b421b475
ms.sourcegitcommit: 7c550d2bcd30f505913e0cd441fbe12ae4a93b27
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/15/2021
ms.locfileid: "53445974"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="2b91b-101">在此练习中，你将完成实现 Azure 函数和 ，并更新测试应用程序以订阅和取消订阅用户 `SetSubscription` `Notify` 收件箱中的更改。</span><span class="sxs-lookup"><span data-stu-id="2b91b-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="2b91b-102">函数将充当 API，允许测试应用创建或删除用户收件箱中更改 `SetSubscription` 的订阅[](https://docs.microsoft.com/graph/webhooks)。</span><span class="sxs-lookup"><span data-stu-id="2b91b-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="2b91b-103">`Notify`函数将充当接收订阅生成的更改通知的 Webhook。</span><span class="sxs-lookup"><span data-stu-id="2b91b-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="2b91b-104">这两个函数都将使用[客户端凭据授予](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow)流获取仅应用令牌，以调用 Microsoft Graph。</span><span class="sxs-lookup"><span data-stu-id="2b91b-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="2b91b-105">由于管理员授予了对所需权限范围的管理员同意，因此无需用户交互来获取令牌。</span><span class="sxs-lookup"><span data-stu-id="2b91b-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="2b91b-106">将客户端凭据身份验证添加到 Azure Functions 项目</span><span class="sxs-lookup"><span data-stu-id="2b91b-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="2b91b-107">在此部分中，你将在 Azure Functions 项目中实现客户端凭据流，以获得与 Microsoft Graph。</span><span class="sxs-lookup"><span data-stu-id="2b91b-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="2b91b-108">在包含 **GraphTu一一l.csproj 的目录中打开 CLI。**</span><span class="sxs-lookup"><span data-stu-id="2b91b-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="2b91b-109">使用下列命令将 webhook 应用程序 ID 和密码添加到密码存储。</span><span class="sxs-lookup"><span data-stu-id="2b91b-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="2b91b-110">将 `YOUR_WEBHOOK_APP_ID_HERE` 替换为 Azure Function **Webhook Graph应用程序 ID。**</span><span class="sxs-lookup"><span data-stu-id="2b91b-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="2b91b-111">将 替换为你在 Azure 门户中为 Azure Function `YOUR_WEBHOOK_APP_SECRET_HERE` **Webhook Graph密码**。</span><span class="sxs-lookup"><span data-stu-id="2b91b-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="2b91b-112">创建客户端凭据身份验证提供程序</span><span class="sxs-lookup"><span data-stu-id="2b91b-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="2b91b-113">在名为 **ClientCredentialsAuthProvider.cs** 的 **./GraphTu一l/Authentication** 目录中创建新文件并添加以下代码。</span><span class="sxs-lookup"><span data-stu-id="2b91b-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="2b91b-114">花些时间考虑 **ClientCredentialsAuthProvider.cs** 中的代码有什么功能。</span><span class="sxs-lookup"><span data-stu-id="2b91b-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="2b91b-115">在构造函数中，它从程序包初始化 **ConfidentialClientApplication。** `Microsoft.Identity.Client`</span><span class="sxs-lookup"><span data-stu-id="2b91b-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="2b91b-116">它使用 `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` 和 `.WithTenantId(tenantId)` 函数将登录访问群体限制为仅指定Microsoft 365访问群体。</span><span class="sxs-lookup"><span data-stu-id="2b91b-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="2b91b-117">在 `GetAccessToken` 函数中，它 `AcquireTokenForClient` 调用 获取应用程序的令牌。</span><span class="sxs-lookup"><span data-stu-id="2b91b-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="2b91b-118">客户端凭据令牌流始终非交互。</span><span class="sxs-lookup"><span data-stu-id="2b91b-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="2b91b-119">它实现 接口，从而允许在 的构造函数中传递此类 `Microsoft.Graph.IAuthenticationProvider` `GraphServiceClient` 以对传出请求进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="2b91b-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="2b91b-120">更新 GraphClientService</span><span class="sxs-lookup"><span data-stu-id="2b91b-120">Update GraphClientService</span></span>

1. <span data-ttu-id="2b91b-121">打开 **GraphClientService.cs，** 将以下属性添加到 类。</span><span class="sxs-lookup"><span data-stu-id="2b91b-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="2b91b-122">将现有的 `GetAppGraphClient` 函数替换为以下内容。</span><span class="sxs-lookup"><span data-stu-id="2b91b-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientFunctions":::

## <a name="implement-notify-function"></a><span data-ttu-id="2b91b-123">实现 Notify 函数</span><span class="sxs-lookup"><span data-stu-id="2b91b-123">Implement Notify function</span></span>

<span data-ttu-id="2b91b-124">在此部分中，你将实现 `Notify` 函数，它将用作更改通知的通知 URL。</span><span class="sxs-lookup"><span data-stu-id="2b91b-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="2b91b-125">在 **GraphTu一ls** 目录中新建一个名为 Models **的目录**。</span><span class="sxs-lookup"><span data-stu-id="2b91b-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="2b91b-126">在 Models 目录中新建 **一个名为\*\*\*\*ResourceData.cs 的文件** 并添加以下代码。</span><span class="sxs-lookup"><span data-stu-id="2b91b-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="2b91b-127">在 Models 目录中新建一个名为 **ChangeNotificationPayload.cs** 的文件，并添加以下代码。</span><span class="sxs-lookup"><span data-stu-id="2b91b-127">Create a new file in the **Models** directory named **ChangeNotificationPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotificationPayload.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="2b91b-128">在 Models 目录中新建 **一个名为\*\*\*\*NotificationList.cs 的文件** 并添加以下代码。</span><span class="sxs-lookup"><span data-stu-id="2b91b-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="2b91b-129">打开 **./GraphTu一l/Notify.cs，** 并将其全部内容替换为以下内容。</span><span class="sxs-lookup"><span data-stu-id="2b91b-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="2b91b-130">花些时间考虑 **Notify.cs** 中的代码功能。</span><span class="sxs-lookup"><span data-stu-id="2b91b-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="2b91b-131">`Run`该函数检查是否存在 `validationToken` 查询参数。</span><span class="sxs-lookup"><span data-stu-id="2b91b-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="2b91b-132">如果该参数存在，它会将请求作为 [验证请求处理](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)，并相应地做出响应。</span><span class="sxs-lookup"><span data-stu-id="2b91b-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="2b91b-133">如果请求不是验证请求，JSON 有效负载会反作用于 `ChangeNotificationCollection` 。</span><span class="sxs-lookup"><span data-stu-id="2b91b-133">If the request is not a validation request, the JSON payload is deserialized into a `ChangeNotificationCollection`.</span></span>
- <span data-ttu-id="2b91b-134">检查列表中的每个通知的预期客户端状态值，并进行处理。</span><span class="sxs-lookup"><span data-stu-id="2b91b-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="2b91b-135">触发通知的邮件会通过 Microsoft Graph。</span><span class="sxs-lookup"><span data-stu-id="2b91b-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="2b91b-136">实现 SetSubscription 函数</span><span class="sxs-lookup"><span data-stu-id="2b91b-136">Implement SetSubscription function</span></span>

<span data-ttu-id="2b91b-137">在此部分中，您将实现 SetSubscription 函数。</span><span class="sxs-lookup"><span data-stu-id="2b91b-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="2b91b-138">此函数将充当由测试应用程序调用以在用户收件箱上创建或删除订阅的 API。</span><span class="sxs-lookup"><span data-stu-id="2b91b-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="2b91b-139">在 Models 目录中新建一个名为 **SetSubscriptionPayload.cs** 的文件并添加以下代码。</span><span class="sxs-lookup"><span data-stu-id="2b91b-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="2b91b-140">打开 **./GraphTu一l/SetSubscription.cs，** 并将其全部内容替换为以下内容。</span><span class="sxs-lookup"><span data-stu-id="2b91b-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="2b91b-141">花些时间考虑 **SetSubscription.cs** 中的代码有什么功能。</span><span class="sxs-lookup"><span data-stu-id="2b91b-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="2b91b-142">函数读取 POST 请求中发送的 JSON 有效负载，以确定请求类型 (订阅或取消订阅) 、要订阅的用户 ID 以及要取消订阅的 `Run` 订阅 ID。</span><span class="sxs-lookup"><span data-stu-id="2b91b-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="2b91b-143">如果请求是订阅请求，它将使用 Microsoft Graph SDK 在指定用户的收件箱中创建新订阅。</span><span class="sxs-lookup"><span data-stu-id="2b91b-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="2b91b-144">订阅将在创建或更新邮件时通知。</span><span class="sxs-lookup"><span data-stu-id="2b91b-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="2b91b-145">新订阅在响应的 JSON 有效负载中返回。</span><span class="sxs-lookup"><span data-stu-id="2b91b-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="2b91b-146">如果请求是取消订阅请求，它将使用 Microsoft Graph SDK 删除指定的订阅。</span><span class="sxs-lookup"><span data-stu-id="2b91b-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="2b91b-147">从测试应用调用 SetSubscription</span><span class="sxs-lookup"><span data-stu-id="2b91b-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="2b91b-148">在此部分中，你将实现用于创建和删除测试应用中的订阅的函数。</span><span class="sxs-lookup"><span data-stu-id="2b91b-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="2b91b-149">打开 **./TestClient/azurefunctions.js** 并添加以下函数。</span><span class="sxs-lookup"><span data-stu-id="2b91b-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="2b91b-150">此代码调用 Azure 函数来订阅并将新订阅添加到会话中 `SetSubscription` 的订阅数组。</span><span class="sxs-lookup"><span data-stu-id="2b91b-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="2b91b-151">将以下函数添加到 **azurefunctions.js**。</span><span class="sxs-lookup"><span data-stu-id="2b91b-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="2b91b-152">此代码调用 `SetSubscription` Azure 函数取消订阅并从会话中的订阅数组中删除订阅。</span><span class="sxs-lookup"><span data-stu-id="2b91b-152">This code calls the `SetSubscription` Azure Function to unsubscribe and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="2b91b-153">如果没有运行 ngrok，请运行 ngrok `ngrok http 7071` () 复制 HTTPS 转发 URL。</span><span class="sxs-lookup"><span data-stu-id="2b91b-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="2b91b-154">通过运行以下命令，将 ngrok URL 添加到用户密码存储。</span><span class="sxs-lookup"><span data-stu-id="2b91b-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="2b91b-155">如果重新启动 ngrok，则需要重复此命令以更新 ngrok URL。</span><span class="sxs-lookup"><span data-stu-id="2b91b-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="2b91b-156">将 CLI 中的当前目录更改为 **./GraphTu一l** 目录，并运行以下命令以在本地启动 Azure Function。</span><span class="sxs-lookup"><span data-stu-id="2b91b-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="2b91b-157">刷新 SPA 并选择" **订阅"** 导航项。</span><span class="sxs-lookup"><span data-stu-id="2b91b-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="2b91b-158">输入组织中具有邮箱的用户Microsoft 365用户EXCHANGE ONLINE ID。</span><span class="sxs-lookup"><span data-stu-id="2b91b-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="2b91b-159">这可以是来自 Microsoft (`id` 的用户Graph) 或用户的 `userPrincipalName` 。</span><span class="sxs-lookup"><span data-stu-id="2b91b-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="2b91b-160">单击 **订阅**。</span><span class="sxs-lookup"><span data-stu-id="2b91b-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="2b91b-161">页面将刷新，在表中显示新订阅。</span><span class="sxs-lookup"><span data-stu-id="2b91b-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="2b91b-162">向用户发送电子邮件。</span><span class="sxs-lookup"><span data-stu-id="2b91b-162">Send an email to the user.</span></span> <span data-ttu-id="2b91b-163">过一小段时间， `Notify` 应调用 函数。</span><span class="sxs-lookup"><span data-stu-id="2b91b-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="2b91b-164">可以在 ngrok Web 界面 () Azure Function 项目的调试输出 `http://localhost:4040` 中对此进行验证。</span><span class="sxs-lookup"><span data-stu-id="2b91b-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="2b91b-165">在测试应用中，单击 **订阅** 的表行中的"删除"。</span><span class="sxs-lookup"><span data-stu-id="2b91b-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="2b91b-166">页面将刷新，并且订阅不再位于表中。</span><span class="sxs-lookup"><span data-stu-id="2b91b-166">The page refreshes and the subscription is no longer in the table.</span></span>
